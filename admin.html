<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eldavily Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- مكتبات لتحميل البيانات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #1a1a1a;
            --accent-color: #c9a96d;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --content-bg: #f5f7fa;
            --card-bg: #ffffff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--content-bg); color: #333; min-height: 100vh; }

        /* Login Styles */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%); }
        .login-form { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 100%; max-width: 400px; }
        .login-form h2 { text-align: center; margin-bottom: 30px; color: var(--primary-color); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #444; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: var(--accent-color); }
        .btn { padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #b89a5f; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }
        .error-message { color: var(--danger-color); font-size: 0.9rem; margin-top: 10px; text-align: center; }
        .success-message { color: var(--success-color); font-size: 0.9rem; margin-top: 10px; text-align: center; }

        /* Admin Panel Styles */
        .admin-panel { display: none; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: white; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; gap: 10px; }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 600; }
        .sidebar-header i { color: var(--accent-color); font-size: 1.8rem; }
        .sidebar-menu { padding: 15px 0; }
        .menu-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background-color: var(--sidebar-hover); border-left: 4px solid var(--accent-color); }
        .menu-item i { width: 20px; text-align: center; }
        .main-content { margin-left: 260px; padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin-bottom: 25px; border-bottom: 1px solid #e0e0e0; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--accent-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .logout-btn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background-color: var(--danger-color); color: white; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        .card-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .bg-primary { background-color: rgba(26, 26, 26, 0.1); color: var(--primary-color); }
        .bg-success { background-color: rgba(40, 167, 69, 0.1); color: var(--success-color); }
        .bg-warning { background-color: rgba(255, 193, 7, 0.1); color: var(--warning-color); }
        .bg-danger { background-color: rgba(220, 53, 69, 0.1); color: var(--danger-color); }
        .bg-info { background-color: rgba(23, 162, 184, 0.1); color: var(--info-color); }
        .card-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .card-desc { color: #666; font-size: 0.9rem; }
        .content-section { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 25px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .section-title { font-size: 1.3rem; font-weight: 600; color: var(--primary-color); }
        .section-actions button { padding: 8px 15px; border: none; border-radius: 4px; background-color: var(--accent-color); color: white; cursor: pointer; font-weight: 500; transition: background-color 0.3s; }
        .section-actions button:hover { background-color: #b89a5f; }
        textarea.form-control { min-height: 120px; resize: vertical; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #218838; }
        .preview-container { border: 1px solid #eee; border-radius: 4px; padding: 15px; margin-top: 15px; background-color: #f9f9f9; min-height: 100px; }
        .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { border-bottom-color: var(--accent-color); color: var(--accent-color); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        /* Modal and List Styles added for new features */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 800px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #888; }
        .list-item { border: 1px solid #eee; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-left: 10px; }
        .status-active { background-color: var(--success-color); }
        .status-expired { background-color: #6c757d; }
        .status-pending { background-color: var(--warning-color); }
        .status-processing { background-color: var(--info-color); }
        .status-shipped { background-color: #17a2b8; }
        .status-delivered { background-color: var(--success-color); }
        .status-cancelled { background-color: var(--danger-color); }
        .status-read { background-color: var(--success-color); }
        .status-unread { background-color: var(--warning-color); }

        /* Order Details Styles */
        .order-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .order-info, .customer-info { background: #f9f9f9; padding: 15px; border-radius: var(--border-radius); }
        .order-info h4, .customer-info h4 { margin-bottom: 15px; color: var(--primary-color); }
        .order-items { margin-top: 20px; }
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .order-item:last-child { border-bottom: none; }
        .order-status-select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-top: 10px; }
        .order-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        /* Statistics Styles */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stats-card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stats-title { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        .stats-value { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
        .stats-change { font-size: 0.9rem; display: flex; align-items: center; }
        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .chart-container { height: 200px; margin-top: 15px; }
        .stats-list { margin-top: 15px; }
        .stats-list-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .stats-list-item:last-child { border-bottom: none; }
        .date-filter { display: flex; gap: 10px; margin-bottom: 20px; }
        .date-filter button { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .date-filter button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* Data Export Styles */
        .export-options { display: flex; gap: 10px; margin-bottom: 20px; }
        .export-btn { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background-color: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .export-btn:hover { background-color: #218838; }
        .export-btn.pdf { background-color: #dc3545; }
        .export-btn.pdf:hover { background-color: #c82333; }
        .export-btn.excel { background-color: #28a745; }
        .export-btn.excel:hover { background-color: #218838; }
        
        /* Table Styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; color: var(--primary-color); }
        .data-table tr:hover { background-color: #f8f9fa; }
        .table-container { overflow-x: auto; }
        
        /* Stock Management Styles */
        .stock-info { display: flex; align-items: center; gap: 5px; }
        .stock-low { color: var(--danger-color); font-weight: bold; }
        .stock-medium { color: var(--warning-color); }
        .stock-high { color: var(--success-color); }
        .stock-actions { display: flex; gap: 5px; }
        .stock-input { width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }

        /* Contact Messages Styles */
        .message-item { border: 1px solid #eee; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; background: #f9f9f9; }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .message-sender { font-weight: bold; color: var(--primary-color); }
        .message-date { color: #666; font-size: 0.9rem; }
        .message-content { margin-bottom: 10px; }
        .message-actions { display: flex; gap: 10px; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; }
            .dashboard-cards { grid-template-columns: 1fr; }
            .order-details { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .export-options { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <h2><i class="fas fa-crown"></i> Eldavily Admin</h2>
            <form id="loginForm">
                <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" required></div>
                <div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary">Sign In</button>
                <div id="loginMessage" class="error-message"></div>
            </form>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <div class="sidebar">
            <div class="sidebar-header"><i class="fas fa-crown"></i><h2>Eldavily Admin</h2></div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></div>
                <div class="menu-item" data-tab="statistics"><i class="fas fa-chart-line"></i><span>Statistics</span></div>
                <div class="menu-item" data-tab="orders"><i class="fas fa-receipt"></i><span>Orders</span></div>
                <div class="menu-item" data-tab="products"><i class="fas fa-box-open"></i><span>Products</span></div>
                <div class="menu-item" data-tab="stock"><i class="fas fa-warehouse"></i><span>Stock Management</span></div>
                <div class="menu-item" data-tab="messages"><i class="fas fa-envelope"></i><span>Customer Messages</span></div>
                <div class="menu-item" data-tab="content"><i class="fas fa-edit"></i><span>Store Content</span></div>
                <div class="menu-item" data-tab="notifications"><i class="fas fa-bell"></i><span>Notifications</span></div>
            </div>
        </div>
        <div class="main-content">
            <div class="top-bar">
                <h1 id="pageTitle">Admin Dashboard</h1>
                <div class="user-info"><div class="user-avatar" id="userAvatar">AD</div><span id="userEmail"></span><button class="logout-btn" id="logoutBtn">Logout</button></div>
            </div>
            
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Store Visits Today</div>
                            <div class="card-icon bg-primary"><i class="fas fa-eye"></i></div>
                        </div>
                        <div class="card-value" id="storeVisits">0</div>
                        <div class="card-desc" id="storeVisitsChange"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Orders</div>
                            <div class="card-icon bg-success"><i class="fas fa-shopping-bag"></i></div>
                        </div>
                        <div class="card-value" id="totalOrders">0</div>
                        <div class="card-desc" id="ordersChange"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Revenue</div>
                            <div class="card-icon bg-warning"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <div class="card-value" id="totalRevenue">$0</div>
                        <div class="card-desc" id="revenueChange"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Customer Messages</div>
                            <div class="card-icon bg-info"><i class="fas fa-envelope"></i></div>
                        </div>
                        <div class="card-value" id="totalMessages">0</div>
                        <div class="card-desc" id="messagesChange"></div>
                    </div>
                </div>
                
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Recent Activity</div>
                    </div>
                    <div id="recentActivity" class="loading">Loading recent activity...</div>
                </div>
            </div>
            
            <div id="statistics" class="tab-content">
                <div class="date-filter">
                    <button class="active" data-range="7">Last 7 Days</button>
                    <button data-range="30">Last 30 Days</button>
                    <button data-range="90">Last 90 Days</button>
                    <button data-range="365">Last Year</button>
                </div>
                
                <div class="export-options">
                    <button class="export-btn pdf" id="exportStatsPdf"><i class="fas fa-file-pdf"></i> Export Statistics as PDF</button>
                    <button class="export-btn excel" id="exportStatsExcel"><i class="fas fa-file-excel"></i> Export Statistics as Excel</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-header">
                            <div class="stats-title">Revenue Overview</div>
                            <div class="stats-change positive" id="revenueStatsChange">+12%</div>
                        </div>
                        <div class="stats-value" id="revenueStatsValue">$0</div>
                        <div class="chart-container" id="revenueChart">
                            <!-- Simple bar chart using CSS -->
                            <div class="chart-bars" style="display: flex; align-items: flex-end; height: 100%; gap: 5px; padding: 10px 0;">
                                <!-- Bars will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <div class="stats-header">
                            <div class="stats-title">Orders Overview</div>
                            <div class="stats-change positive" id="ordersStatsChange">+8%</div>
                        </div>
                        <div class="stats-value" id="ordersStatsValue">0</div>
                        <div class="chart-container" id="ordersChart">
                            <!-- Simple bar chart using CSS -->
                            <div class="chart-bars" style="display: flex; align-items: flex-end; height: 100%; gap: 5px; padding: 10px 0;">
                                <!-- Bars will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <div class="stats-header">
                            <div class="stats-title">Top Products</div>
                        </div>
                        <div class="stats-list" id="topProductsList">
                            <!-- Top products will be listed here -->
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <div class="stats-header">
                            <div class="stats-title">Order Status Distribution</div>
                        </div>
                        <div class="chart-container" id="statusChart">
                            <!-- Simple pie chart using CSS -->
                            <div class="pie-chart" style="width: 150px; height: 150px; border-radius: 50%; margin: 0 auto; background: conic-gradient(
                                var(--success-color) 0% 40%, 
                                var(--warning-color) 40% 65%, 
                                var(--info-color) 65% 85%, 
                                var(--danger-color) 85% 100%
                            );"></div>
                        </div>
                        <div class="stats-list" id="statusLegend">
                            <!-- Status legend will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="orders" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Recent Orders</div>
                        <div class="export-options">
                            <button class="export-btn pdf" id="exportOrdersPdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                            <button class="export-btn excel" id="exportOrdersExcel"><i class="fas fa-file-excel"></i> Export as Excel</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Stock Processed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersList">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="products" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Product Management</div>
                        <div class="section-actions">
                            <button id="addNewProductBtn">Add New Product</button>
                            <div class="export-options">
                                <button class="export-btn pdf" id="exportProductsPdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                                <button class="export-btn excel" id="exportProductsExcel"><i class="fas fa-file-excel"></i> Export as Excel</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsList">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="stock" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Stock Management</div>
                        <div class="export-options">
                            <button class="export-btn pdf" id="exportStockPdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                            <button class="export-btn excel" id="exportStockExcel"><i class="fas fa-file-excel"></i> Export as Excel</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="stockTable">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Current Stock</th>
                                    <th>Low Stock Alert</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stockList">
                                <!-- Stock items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- NEW: Customer Messages Tab -->
            <div id="messages" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Customer Messages</div>
                        <div class="export-options">
                            <button class="export-btn pdf" id="exportMessagesPdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                            <button class="export-btn excel" id="exportMessagesExcel"><i class="fas fa-file-excel"></i> Export as Excel</button>
                        </div>
                    </div>
                    <div id="customerMessagesList">
                        <!-- Customer messages will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div id="content" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Hero Section Content</div>
                    </div>
                    <div class="form-group"><label for="heroTitle">Hero Title</label><input type="text" id="heroTitle" class="form-control"></div>
                    <div class="form-group"><label for="heroSubtitle">Hero Subtitle</label><textarea id="heroSubtitle" class="form-control"></textarea></div>
                    <div class="form-group"><label for="heroButtonText">Button Text</label><input type="text" id="heroButtonText" class="form-control"></div>
                    <button id="saveHeroBtn" class="btn-primary btn">Save Hero Content</button>
                </div>
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Background Control</div>
                    </div>
                    <div class="form-group"><label for="bgType">Background Type</label><select id="bgType" class="form-control"><option value="image">Image</option><option value="color">Solid Color</option><option value="gradient">Gradient</option></select></div>
                    <div id="bgImageOptions"><div class="form-group"><label for="bgImageUrl">Background Image URL</label><input type="text" id="bgImageUrl" class="form-control"></div></div>
                    <div id="bgColorOptions" style="display:none;"><div class="form-group"><label for="bgColor">Background Color</label><input type="color" id="bgColor" class="form-control" value="#ffffff"></div></div>
                    <div id="bgGradientOptions" style="display:none;"><div class="form-group"><label for="gradientColors">Gradient Colors (comma separated)</label><input type="text" id="gradientColors" class="form-control"></div></div>
                    <button id="saveBgBtn" class="btn-primary btn">Save Background Settings</button>
                </div>
            </div>
            
            <div id="notifications" class="tab-content">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Send Customer Notifications</div>
                    </div>
                    <div class="form-group"><label for="notificationTitle">Notification Title</label><input type="text" id="notificationTitle" class="form-control"></div>
                    <div class="form-group"><label for="notificationMessage">Notification Message</label><textarea id="notificationMessage" class="form-control"></textarea></div>
                    <div style="display:flex; gap:20px;">
                        <div class="form-group" style="flex:1;"><label for="notificationExpiry">Display Until (Optional)</label><input type="datetime-local" id="notificationExpiry" class="form-control"></div>
                        <div class="form-group" style="flex:1;"><label for="notificationPosition">Position</label><select id="notificationPosition" class="form-control"><option value="top">Top Bar</option><option value="bottom">Bottom Banner</option></select></div>
                    </div>
                    <button id="sendNotificationBtn" class="btn btn-success"><i class="fas fa-paper-plane"></i> Send Notification</button>
                </div>
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Notification History</div>
                        <div class="export-options">
                            <button class="export-btn pdf" id="exportNotificationsPdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                            <button class="export-btn excel" id="exportNotificationsExcel"><i class="fas fa-file-excel"></i> Export as Excel</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="notificationsTable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Message</th>
                                    <th>Position</th>
                                    <th>Sent Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="notificationHistory">
                                <!-- Notifications will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Modal -->
    <div id="productModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="productModalClose">&times;</span>
            <h3 id="productModalTitle" style="margin-bottom:20px;">Add New Product</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group"><label for="productName">Name</label><input type="text" id="productName" class="form-control" required></div>
                <div class="form-group"><label for="productPrice">Price</label><input type="number" id="productPrice" class="form-control" step="0.01" required></div>
                <div class="form-group"><label for="productStock">Stock Quantity</label><input type="number" id="productStock" class="form-control" required></div>
                <div class="form-group"><label for="productLowStockAlert">Low Stock Alert</label><input type="number" id="productLowStockAlert" class="form-control" value="5"></div>
                <div class="form-group"><label for="productImageUrl">Image URL</label><input type="text" id="productImageUrl" class="form-control"></div>
                <div class="form-group"><label for="productDescription">Description</label><textarea id="productDescription" class="form-control"></textarea></div>
                <button type="submit" class="btn btn-primary">Save Product</button>
            </form>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="orderModalClose">&times;</span>
            <h3 id="orderModalTitle" style="margin-bottom:20px;">Order Details</h3>
            <div id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Stock Update Modal -->
    <div id="stockModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="stockModalClose">&times;</span>
            <h3 id="stockModalTitle" style="margin-bottom:20px;">Update Stock</h3>
            <form id="stockForm">
                <input type="hidden" id="stockProductId">
                <div class="form-group">
                    <label for="stockProductName">Product Name</label>
                    <input type="text" id="stockProductName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="stockCurrent">Current Stock</label>
                    <input type="number" id="stockCurrent" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="stockAdjustment">Adjustment</label>
                    <input type="number" id="stockAdjustment" class="form-control" required>
                    <small>Positive number to add stock, negative to remove</small>
                </div>
                <div class="form-group">
                    <label for="stockReason">Reason for Adjustment</label>
                    <select id="stockReason" class="form-control">
                        <option value="restock">Restock</option>
                        <option value="sale">Sale</option>
                        <option value="damaged">Damaged</option>
                        <option value="return">Customer Return</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="stockNotes">Notes (Optional)</label>
                    <textarea id="stockNotes" class="form-control"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Stock</button>
            </form>
        </div>
    </div>

    <!-- Message Details Modal -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="messageModalClose">&times;</span>
            <h3 id="messageModalTitle" style="margin-bottom:20px;">Message Details</h3>
            <div id="messageDetailsContent">
                <!-- Message details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDuaP43jD8LWw5A8cIbcgS7-bqCZTXzEEg",
            authDomain: "davily-feded.firebaseapp.com",
            databaseURL: "https://davily-feded-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "davily-feded",
            storageBucket: "davily-feded.appspot.com",
            messagingSenderId: "83255410493",
            appId: "1:83255410493:web:927c5e859c5b20805c4f54",
            measurementId: "G-LD4XHS6FGM"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Global variables for statistics
        let currentDateRange = 7;
        let ordersData = {};
        let productsData = {};
        let stockHistoryData = {};
        let contactMessagesData = {};

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                initializeAdminPanel();
            } else {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .catch(error => document.getElementById('loginMessage').textContent = error.message);
        });
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        
        function initializeAdminPanel() {
            setupTabs();
            setupEventListeners();
            loadAllData();
            setupOrderListener();
        }

        function setupTabs() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById('pageTitle').textContent = item.querySelector('span').textContent;
                    
                    // Load statistics when the tab is activated
                    if (tabId === 'statistics') {
                        loadStatistics(currentDateRange);
                    }
                });
            });
            
            // Date range filter buttons
            document.querySelectorAll('.date-filter button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.date-filter button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentDateRange = parseInt(this.dataset.range);
                    loadStatistics(currentDateRange);
                });
            });
        }
        
        function setupEventListeners() {
            document.getElementById('saveHeroBtn').addEventListener('click', () => db.ref('admin/heroContent').set({ title: document.getElementById('heroTitle').value, subtitle: document.getElementById('heroSubtitle').value, buttonText: document.getElementById('heroButtonText').value }));
            document.getElementById('saveBgBtn').addEventListener('click', () => db.ref('admin/background').set({ type: document.getElementById('bgType').value, imageUrl: document.getElementById('bgImageUrl').value, color: document.getElementById('bgColor').value, gradientColors: document.getElementById('gradientColors').value }));
            document.getElementById('bgType').addEventListener('change', () => { const type = document.getElementById('bgType').value; document.getElementById('bgImageOptions').style.display = type === 'image' ? 'block' : 'none'; document.getElementById('bgColorOptions').style.display = type === 'color' ? 'block' : 'none'; document.getElementById('bgGradientOptions').style.display = type === 'gradient' ? 'block' : 'none'; });
            document.getElementById('sendNotificationBtn').addEventListener('click', sendNotification);
            document.getElementById('addNewProductBtn').addEventListener('click', () => openProductModal());
            document.getElementById('productModalClose').addEventListener('click', () => document.getElementById('productModal').style.display = 'none');
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('orderModalClose').addEventListener('click', () => document.getElementById('orderModal').style.display = 'none');
            document.getElementById('stockModalClose').addEventListener('click', () => document.getElementById('stockModal').style.display = 'none');
            document.getElementById('stockForm').addEventListener('submit', updateStock);
            document.getElementById('messageModalClose').addEventListener('click', () => document.getElementById('messageModal').style.display = 'none');
            
            // Export buttons
            document.getElementById('exportStatsPdf').addEventListener('click', () => exportStatisticsToPdf());
            document.getElementById('exportStatsExcel').addEventListener('click', () => exportStatisticsToExcel());
            document.getElementById('exportOrdersPdf').addEventListener('click', () => exportOrdersToPdf());
            document.getElementById('exportOrdersExcel').addEventListener('click', () => exportOrdersToExcel());
            document.getElementById('exportProductsPdf').addEventListener('click', () => exportProductsToPdf());
            document.getElementById('exportProductsExcel').addEventListener('click', () => exportProductsToExcel());
            document.getElementById('exportStockPdf').addEventListener('click', () => exportStockToPdf());
            document.getElementById('exportStockExcel').addEventListener('click', () => exportStockToExcel());
            document.getElementById('exportMessagesPdf').addEventListener('click', () => exportMessagesToPdf());
            document.getElementById('exportMessagesExcel').addEventListener('click', () => exportMessagesToExcel());
            document.getElementById('exportNotificationsPdf').addEventListener('click', () => exportNotificationsToPdf());
            document.getElementById('exportNotificationsExcel').addEventListener('click', () => exportNotificationsToExcel());
        }

        function setupOrderListener() {
            // Listen for new orders and automatically deduct stock
            db.ref('orders').on('child_added', (snapshot) => {
                const order = snapshot.val();
                const orderId = snapshot.key;
                
                // Check if this order has already been processed for stock deduction
                if (!order.stockProcessed) {
                    processOrderStock(orderId, order);
                }
            });
        }

        function processOrderStock(orderId, order) {
            if (!order.items || !Array.isArray(order.items)) {
                console.log('No items in order to process');
                return;
            }

            let allItemsProcessed = true;
            const stockUpdates = {};

            // Process each item in the order
            order.items.forEach(item => {
                const productId = item.productId;
                const quantity = item.quantity || 1;
                
                if (productId && productsData[productId]) {
                    const currentStock = productsData[productId].stock || 0;
                    
                    if (currentStock >= quantity) {
                        // Deduct stock
                        const newStock = currentStock - quantity;
                        stockUpdates[productId] = newStock;
                        
                        // Record stock history
                        const stockHistory = {
                            productId: productId,
                            productName: productsData[productId].name,
                            previousStock: currentStock,
                            newStock: newStock,
                            adjustment: -quantity,
                            reason: 'order_placement',
                            orderId: orderId,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            updatedBy: 'system'
                        };
                        db.ref('stockHistory').push(stockHistory);
                        
                        // Update product status automatically based on stock
                        updateProductStatus(productId, newStock, productsData[productId].lowStockAlert);
                        
                    } else {
                        // Not enough stock
                        allItemsProcessed = false;
                        console.log(`Insufficient stock for product ${productId}: requested ${quantity}, available ${currentStock}`);
                    }
                } else {
                    allItemsProcessed = false;
                }
            });

            // Update all product stocks at once
            if (Object.keys(stockUpdates).length > 0) {
                Object.keys(stockUpdates).forEach(productId => {
                    db.ref(`products/${productId}/stock`).set(stockUpdates[productId]);
                });
            }

            // Mark order as processed
            if (allItemsProcessed) {
                db.ref(`orders/${orderId}/stockProcessed`).set(true)
                    .then(() => {
                        console.log('Order stock processed successfully');
                    })
                    .catch(error => {
                        console.error('Error marking order as processed:', error);
                    });
            }
        }

        function updateProductStatus(productId, newStock, lowStockAlert = 5) {
            let status = 'active';
            
            if (newStock <= 0) {
                status = 'out_of_stock';
            } else if (newStock <= lowStockAlert) {
                status = 'low_stock';
            }
            
            db.ref(`products/${productId}/status`).set(status)
                .then(() => {
                    console.log(`Product ${productId} status updated to: ${status}`);
                })
                .catch(error => {
                    console.error('Error updating product status:', error);
                });
        }

        function loadAllData() {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`analytics/storeVisits/${today}`).on('value', s => {
                const visits = s.val() || 0;
                document.getElementById('storeVisits').textContent = visits;
                // Calculate change from yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                db.ref(`analytics/storeVisits/${yesterdayStr}`).once('value').then(yestSnapshot => {
                    const yestVisits = yestSnapshot.val() || 0;
                    const change = yestVisits > 0 ? ((visits - yestVisits) / yestVisits * 100).toFixed(1) : 0;
                    document.getElementById('storeVisitsChange').textContent = `${change >= 0 ? '+' : ''}${change}% from yesterday`;
                    document.getElementById('storeVisitsChange').className = `card-desc ${change >= 0 ? 'positive' : 'negative'}`;
                });
            });
            
            db.ref('products').on('value', s => {
                productsData = s.val() || {};
                renderData(s, 'products', renderProductItem, 'totalProducts');
                
                // Calculate products change
                const productCount = Object.keys(productsData).length;
                document.getElementById('totalProducts').textContent = productCount;
                document.getElementById('productsChange').textContent = `+${productCount} total products`;
            });
            
            db.ref('orders').on('value', s => {
                ordersData = s.val() || {};
                renderData(s, 'orders', renderOrderItem, ['totalOrders', 'totalRevenue']);
                loadRecentActivity();
                
                // Calculate orders and revenue changes
                const orderCount = Object.keys(ordersData).length;
                const revenue = Object.values(ordersData).reduce((sum, order) => sum + (order.total || 0), 0);
                
                document.getElementById('totalOrders').textContent = orderCount;
                document.getElementById('totalRevenue').textContent = `$${revenue.toFixed(2)}`;
                
                document.getElementById('ordersChange').textContent = `+${orderCount} total orders`;
                document.getElementById('revenueChange').textContent = `Total revenue: $${revenue.toFixed(2)}`;
            });
            
            // Load customer messages
            db.ref('contactMessages').on('value', s => {
                contactMessagesData = s.val() || {};
                renderData(s, 'messages', renderMessageItem, 'totalMessages');
                
                // Calculate messages count
                const messageCount = Object.keys(contactMessagesData).length;
                document.getElementById('totalMessages').textContent = messageCount;
                document.getElementById('messagesChange').textContent = `${messageCount} total messages`;
            });
            
            db.ref('notifications').on('value', s => renderData(s, 'notifications', renderNotificationItem, null));
            
            // Load stock history
            db.ref('stockHistory').on('value', s => {
                stockHistoryData = s.val() || {};
            });
        }
        
        function loadStatistics(dateRange) {
            // Calculate date range
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - dateRange);
            
            // Filter orders by date range
            const filteredOrders = {};
            if (ordersData) {
                Object.keys(ordersData).forEach(key => {
                    const order = ordersData[key];
                    const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                    if (orderDate >= startDate && orderDate <= endDate) {
                        filteredOrders[key] = order;
                    }
                });
            }
            
            // Calculate statistics
            const revenue = Object.values(filteredOrders).reduce((sum, order) => sum + (order.total || 0), 0);
            const orderCount = Object.keys(filteredOrders).length;
            
            // Update statistics values
            document.getElementById('revenueStatsValue').textContent = `$${revenue.toFixed(2)}`;
            document.getElementById('ordersStatsValue').textContent = orderCount;
            
            // Generate simple charts
            generateRevenueChart(filteredOrders, dateRange);
            generateOrdersChart(filteredOrders, dateRange);
            generateTopProductsList(filteredOrders);
            generateStatusChart(filteredOrders);
        }
        
        function generateRevenueChart(orders, dateRange) {
            const chartContainer = document.querySelector('#revenueChart .chart-bars');
            chartContainer.innerHTML = '';
            
            // Group revenue by day
            const dailyRevenue = {};
            Object.values(orders).forEach(order => {
                const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                const dateStr = orderDate.toISOString().split('T')[0];
                
                if (!dailyRevenue[dateStr]) {
                    dailyRevenue[dateStr] = 0;
                }
                dailyRevenue[dateStr] += order.total || 0;
            });
            
            // Create bars for each day
            const maxRevenue = Math.max(...Object.values(dailyRevenue), 1);
            
            for (let i = dateRange - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const revenue = dailyRevenue[dateStr] || 0;
                const height = (revenue / maxRevenue) * 100;
                
                const bar = document.createElement('div');
                bar.style.height = `${height}%`;
                bar.style.backgroundColor = 'var(--accent-color)';
                bar.style.flex = '1';
                bar.style.borderRadius = '2px';
                bar.title = `$${revenue.toFixed(2)} - ${dateStr}`;
                
                chartContainer.appendChild(bar);
            }
        }
        
        function generateOrdersChart(orders, dateRange) {
            const chartContainer = document.querySelector('#ordersChart .chart-bars');
            chartContainer.innerHTML = '';
            
            // Group orders by day
            const dailyOrders = {};
            Object.values(orders).forEach(order => {
                const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                const dateStr = orderDate.toISOString().split('T')[0];
                
                if (!dailyOrders[dateStr]) {
                    dailyOrders[dateStr] = 0;
                }
                dailyOrders[dateStr] += 1;
            });
            
            // Create bars for each day
            const maxOrders = Math.max(...Object.values(dailyOrders), 1);
            
            for (let i = dateRange - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const orderCount = dailyOrders[dateStr] || 0;
                const height = (orderCount / maxOrders) * 100;
                
                const bar = document.createElement('div');
                bar.style.height = `${height}%`;
                bar.style.backgroundColor = 'var(--success-color)';
                bar.style.flex = '1';
                bar.style.borderRadius = '2px';
                bar.title = `${orderCount} orders - ${dateStr}`;
                
                chartContainer.appendChild(bar);
            }
        }
        
        function generateTopProductsList(orders) {
            const topProductsList = document.getElementById('topProductsList');
            topProductsList.innerHTML = '';
            
            // Count product sales
            const productSales = {};
            Object.values(orders).forEach(order => {
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        const productId = item.productId || item.name;
                        if (!productSales[productId]) {
                            productSales[productId] = { count: 0, revenue: 0, name: item.name };
                        }
                        productSales[productId].count += item.quantity || 1;
                        productSales[productId].revenue += (item.price || 0) * (item.quantity || 1);
                    });
                }
            });
            
            // Sort by revenue and take top 5
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            if (topProducts.length === 0) {
                topProductsList.innerHTML = '<p>No product sales in this period</p>';
                return;
            }
            
            topProducts.forEach(([productId, data]) => {
                const item = document.createElement('div');
                item.className = 'stats-list-item';
                item.innerHTML = `
                    <span>${data.name || productId}</span>
                    <span>$${data.revenue.toFixed(2)} (${data.count} sold)</span>
                `;
                topProductsList.appendChild(item);
            });
        }
        
        function generateStatusChart(orders) {
            const statusCounts = {
                pending: 0,
                processing: 0,
                shipped: 0,
                delivered: 0,
                cancelled: 0
            };
            
            // Count orders by status
            Object.values(orders).forEach(order => {
                const status = order.status || 'pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            // Update status legend
            const statusLegend = document.getElementById('statusLegend');
            statusLegend.innerHTML = '';
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (count > 0) {
                    const item = document.createElement('div');
                    item.className = 'stats-list-item';
                    item.innerHTML = `
                        <span><span class="status-badge status-${status}">${status}</span></span>
                        <span>${count} orders</span>
                    `;
                    statusLegend.appendChild(item);
                }
            });
            
            if (Object.values(statusCounts).every(count => count === 0)) {
                statusLegend.innerHTML = '<p>No orders in this period</p>';
            }
        }
        
        function loadRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '';
            
            if (!ordersData || Object.keys(ordersData).length === 0) {
                recentActivity.innerHTML = '<p>No recent activity</p>';
                return;
            }
            
            // Get latest 5 orders
            const latestOrders = Object.entries(ordersData)
                .sort((a, b) => new Date(b[1].createdAt || b[1].timestamp || 0) - new Date(a[1].createdAt || a[1].timestamp || 0))
                .slice(0, 5);
            
            latestOrders.forEach(([id, order]) => {
                const status = order.status || 'pending';
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${order.customer?.name || 'Unknown Customer'}</strong> 
                            - $${(order.total || 0).toFixed(2)}
                            <span class="status-badge status-${status}">${status}</span>
                        </div>
                        <small>${new Date(order.createdAt || order.timestamp || Date.now()).toLocaleString()}</small>
                    </div>
                `;
                recentActivity.appendChild(item);
            });
        }

        function renderData(snapshot, type, renderer, analyticsKey) {
            const container = document.getElementById(`${type}List`) || document.getElementById(`${type}History`) || document.getElementById('customerMessagesList');
            if (!container) return;
            
            container.innerHTML = '';
            const data = snapshot.val();
            if (data) {
                Object.keys(data).reverse().forEach(key => {
                    if (type === 'products') {
                        container.innerHTML += renderer(key, data[key]);
                    } else if (type === 'orders') {
                        container.innerHTML += renderer(key, data[key]);
                    } else if (type === 'notifications') {
                        container.innerHTML += renderer(key, data[key]);
                    } else if (type === 'messages') {
                        container.innerHTML += renderer(key, data[key]);
                    }
                });
                
                // Also update stock management tab
                if (type === 'products') {
                    updateStockManagement(data);
                }
                
                if (analyticsKey) {
                    if (Array.isArray(analyticsKey)) {
                        document.getElementById(analyticsKey[0]).textContent = Object.keys(data).length;
                        const revenue = Object.values(data).reduce((sum, order) => sum + (order.total || 0), 0);
                        document.getElementById(analyticsKey[1]).textContent = `$${revenue.toFixed(2)}`;
                    } else {
                        document.getElementById(analyticsKey).textContent = Object.keys(data).length;
                    }
                }
            } else {
                container.innerHTML = `<p>No ${type} found.</p>`;
            }
        }
        
        function renderProductItem(id, p) { 
            const stockStatus = getStockStatus(p.stock, p.lowStockAlert);
            const statusBadge = getStatusBadge(p.status);
            return `<tr>
                <td>${p.name}</td>
                <td>$${Number(p.price).toFixed(2)}</td>
                <td class="stock-info ${stockStatus.class}">
                    <span>${p.stock || 0}</span>
                    ${p.stock <= (p.lowStockAlert || 5) ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                </td>
                <td>${statusBadge}</td>
                <td>
                    <button onclick="editProduct('${id}')" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></button>
                    <button onclick="updateStockModal('${id}')" class="btn btn-sm" style="background-color:var(--info-color); margin-left:5px;"><i class="fas fa-boxes"></i></button>
                    <button onclick="deleteProduct('${id}')" class="btn btn-sm" style="background-color:var(--danger-color); margin-left:5px;"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }
        
        function renderOrderItem(id, o) { 
            const status = o.status || 'pending';
            const statusClass = `status-${status}`;
            const stockProcessed = o.stockProcessed ? 
                '<span class="status-badge status-active" style="background-color: var(--success-color);">Processed</span>' : 
                '<span class="status-badge status-pending" style="background-color: var(--warning-color);">Pending</span>';
            return `<tr>
                <td>#${id.substring(0, 8)}</td>
                <td>${o.customer?.name || 'Unknown Customer'}</td>
                <td>${new Date(o.createdAt || o.timestamp || Date.now()).toLocaleDateString()}</td>
                <td>$${(o.total || 0).toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                <td>${stockProcessed}</td>
                <td>
                    <button onclick="viewOrderDetails('${id}')" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View</button>
                    <button onclick="deleteOrder('${id}')" class="btn btn-sm" style="background-color:var(--danger-color); margin-left:5px;"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }
        
        function renderMessageItem(id, m) {
            const isRead = m.read || false;
            const statusClass = isRead ? 'status-read' : 'status-unread';
            const statusText = isRead ? 'Read' : 'Unread';
            
            return `
                <div class="message-item">
                    <div class="message-header">
                        <div class="message-sender">${m.name} (${m.email})</div>
                        <div class="message-date">${new Date(m.sentAt).toLocaleString()}</div>
                    </div>
                    <div class="message-content">
                        <p><strong>Phone:</strong> ${m.phone || 'Not provided'}</p>
                        <p><strong>Message:</strong> ${m.message}</p>
                    </div>
                    <div class="message-actions">
                        <button onclick="viewMessageDetails('${id}')" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View Details</button>
                        <button onclick="markAsRead('${id}')" class="btn btn-sm" style="background-color:var(--success-color);"><i class="fas fa-check"></i> Mark as Read</button>
                        <button onclick="deleteMessage('${id}')" class="btn btn-sm" style="background-color:var(--danger-color);"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                </div>
            `;
        }
        
        function renderNotificationItem(id, n) {
            const isExpired = n.displayUntil && new Date(n.displayUntil) < new Date();
            const status = isExpired ? 'Expired' : 'Active';
            const statusClass = isExpired ? 'status-expired' : 'status-active';
            return `<tr>
                <td>${n.title}</td>
                <td>${n.message}</td>
                <td>${n.position || 'top'}</td>
                <td>${new Date(n.sentAt).toLocaleString()}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>
                    <button onclick="deleteNotification('${id}')" class="btn btn-sm" style="background-color:var(--danger-color);"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }
        
        function getStockStatus(stock, lowStockAlert = 5) {
            if (stock <= 0) {
                return { class: 'stock-low', text: 'Out of Stock' };
            } else if (stock <= lowStockAlert) {
                return { class: 'stock-low', text: 'Low Stock' };
            } else if (stock <= lowStockAlert * 2) {
                return { class: 'stock-medium', text: 'Medium Stock' };
            } else {
                return { class: 'stock-high', text: 'In Stock' };
            }
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'active':
                    return '<span class="status-badge status-active">Active</span>';
                case 'out_of_stock':
                    return '<span class="status-badge status-expired">Out of Stock</span>';
                case 'low_stock':
                    return '<span class="status-badge status-pending">Low Stock</span>';
                default:
                    return '<span class="status-badge status-active">Active</span>';
            }
        }
        
        function updateStockManagement(products) {
            const stockList = document.getElementById('stockList');
            if (!stockList) return;
            
            stockList.innerHTML = '';
            
            Object.keys(products).forEach(key => {
                const p = products[key];
                const stockStatus = getStockStatus(p.stock, p.lowStockAlert);
                const statusBadge = getStatusBadge(p.status);
                
                stockList.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td class="stock-info ${stockStatus.class}">
                            <span>${p.stock || 0}</span>
                            ${p.stock <= (p.lowStockAlert || 5) ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                        </td>
                        <td>${p.lowStockAlert || 5}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button onclick="updateStockModal('${key}')" class="btn btn-sm" style="background-color:var(--info-color);"><i class="fas fa-edit"></i> Update</button>
                            <button onclick="viewStockHistory('${key}')" class="btn btn-sm btn-primary" style="margin-left:5px;"><i class="fas fa-history"></i> History</button>
                        </td>
                    </tr>
                `;
            });
        }

        function sendNotification() {
            const data = { 
                title: document.getElementById('notificationTitle').value, 
                message: document.getElementById('notificationMessage').value, 
                position: document.getElementById('notificationPosition').value, 
                sentAt: firebase.database.ServerValue.TIMESTAMP 
            };
            const expiry = document.getElementById('notificationExpiry').value;
            if (expiry) data.displayUntil = new Date(expiry).toISOString();
            db.ref('notifications').push(data).then(() => {
                document.getElementById('notificationTitle').value = '';
                document.getElementById('notificationMessage').value = '';
                document.getElementById('notificationExpiry').value = '';
            });
        }
        
        window.deleteNotification = id => { 
            if (confirm('Delete this notification?')) db.ref(`notifications/${id}`).remove(); 
        }
        
        window.viewOrderDetails = id => {
            db.ref(`orders/${id}`).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) {
                    alert('Order not found');
                    return;
                }
                
                document.getElementById('orderModalTitle').textContent = `Order #${id.substring(0, 8)}`;
                
                // Format order items
                let itemsHtml = '';
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        itemsHtml += `
                            <div class="order-item">
                                <div>${item.name || 'Unknown Product'} x ${item.quantity || 1}</div>
                                <div>$${(item.price || 0).toFixed(2)}</div>
                            </div>
                        `;
                    });
                }
                
                // Status options
                const statusOptions = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];
                const statusSelect = statusOptions.map(status => 
                    `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status.charAt(0).toUpperCase() + status.slice(1)}</option>`
                ).join('');
                
                const stockProcessedInfo = order.stockProcessed ? 
                    '<p style="color:var(--success-color);"><i class="fas fa-check-circle"></i> Stock has been processed</p>' : 
                    '<p style="color:var(--warning-color);"><i class="fas fa-clock"></i> Stock processing pending</p>';
                
                document.getElementById('orderDetailsContent').innerHTML = `
                    <div class="order-details">
                        <div class="order-info">
                            <h4>Order Information</h4>
                            <p><strong>Order ID:</strong> ${id}</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt || order.timestamp || Date.now()).toLocaleString()}</p>
                            <p><strong>Total:</strong> $${(order.total || 0).toFixed(2)}</p>
                            ${stockProcessedInfo}
                            <label for="orderStatus"><strong>Status:</strong></label>
                            <select id="orderStatus" class="order-status-select" onchange="updateOrderStatus('${id}', this.value)">
                                ${statusSelect}
                            </select>
                        </div>
                        <div class="customer-info">
                            <h4>Customer Information</h4>
                            <p><strong>Name:</strong> ${order.customer?.name || 'Not provided'}</p>
                            <p><strong>Email:</strong> ${order.customer?.email || 'Not provided'}</p>
                            <p><strong>Phone:</strong> ${order.customer?.phone || 'Not provided'}</p>
                            <p><strong>Address:</strong> ${order.customer?.address || 'Not provided'}</p>
                        </div>
                    </div>
                    <div class="order-items">
                        <h4>Order Items</h4>
                        ${itemsHtml || '<p>No items found</p>'}
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="printOrder('${id}')"><i class="fas fa-print"></i> Print</button>
                        <button class="btn" style="background-color:var(--danger-color);" onclick="deleteOrder('${id}')"><i class="fas fa-trash"></i> Delete Order</button>
                    </div>
                `;
                
                document.getElementById('orderModal').style.display = 'flex';
            });
        };
        
        window.updateOrderStatus = (orderId, newStatus) => {
            db.ref(`orders/${orderId}/status`).set(newStatus)
                .then(() => {
                    console.log('Order status updated successfully');
                })
                .catch(error => {
                    console.error('Error updating order status: ' + error.message);
                });
        };
        
        window.printOrder = (orderId) => {
            // Simple print functionality - in a real app, you'd create a proper print layout
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Order #${orderId}</title></head>
                <body>
                    <h1>Order #${orderId}</h1>
                    <p>Printed on: ${new Date().toLocaleString()}</p>
                    <div id="printContent"></div>
                </body>
                </html>
            `);
            
            // Copy the order details to the print window
            setTimeout(() => {
                printWindow.document.getElementById('printContent').innerHTML = document.getElementById('orderDetailsContent').innerHTML;
                printWindow.print();
            }, 500);
        };
        
        window.deleteOrder = id => {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                db.ref(`orders/${id}`).remove()
                    .then(() => {
                        alert('Order deleted successfully');
                        document.getElementById('orderModal').style.display = 'none';
                    })
                    .catch(error => {
                        alert('Error deleting order: ' + error.message);
                    });
            }
        };
        
        // Customer Messages Functions
        window.viewMessageDetails = id => {
            db.ref(`contactMessages/${id}`).once('value').then(snapshot => {
                const message = snapshot.val();
                if (!message) {
                    alert('Message not found');
                    return;
                }
                
                document.getElementById('messageModalTitle').textContent = `Message from ${message.name}`;
                
                document.getElementById('messageDetailsContent').innerHTML = `
                    <div class="message-details">
                        <div class="form-group">
                            <label><strong>Name:</strong></label>
                            <p>${message.name}</p>
                        </div>
                        <div class="form-group">
                            <label><strong>Email:</strong></label>
                            <p>${message.email}</p>
                        </div>
                        <div class="form-group">
                            <label><strong>Phone:</strong></label>
                            <p>${message.phone || 'Not provided'}</p>
                        </div>
                        <div class="form-group">
                            <label><strong>Message:</strong></label>
                            <p>${message.message}</p>
                        </div>
                        <div class="form-group">
                            <label><strong>Sent At:</strong></label>
                            <p>${new Date(message.sentAt).toLocaleString()}</p>
                        </div>
                        <div class="form-group">
                            <label><strong>Status:</strong></label>
                            <p>${message.read ? '<span class="status-badge status-read">Read</span>' : '<span class="status-badge status-unread">Unread</span>'}</p>
                        </div>
                    </div>
                    <div class="message-actions" style="margin-top: 20px;">
                        <button onclick="markAsRead('${id}')" class="btn" style="background-color:var(--success-color);"><i class="fas fa-check"></i> Mark as Read</button>
                        <button onclick="deleteMessage('${id}')" class="btn" style="background-color:var(--danger-color); margin-left:10px;"><i class="fas fa-trash"></i> Delete Message</button>
                    </div>
                `;
                
                document.getElementById('messageModal').style.display = 'flex';
            });
        };
        
        window.markAsRead = id => {
            db.ref(`contactMessages/${id}/read`).set(true)
                .then(() => {
                    console.log('Message marked as read');
                    document.getElementById('messageModal').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error marking message as read:', error);
                });
        };
        
        window.deleteMessage = id => {
            if (confirm('Are you sure you want to delete this message?')) {
                db.ref(`contactMessages/${id}`).remove()
                    .then(() => {
                        alert('Message deleted successfully');
                        document.getElementById('messageModal').style.display = 'none';
                    })
                    .catch(error => {
                        alert('Error deleting message: ' + error.message);
                    });
            }
        };
        
        function openProductModal(id = null) {
            const form = document.getElementById('productForm');
            form.reset();
            document.getElementById('productId').value = id || '';
            document.getElementById('productModalTitle').textContent = id ? 'Edit Product' : 'Add New Product';
            if (id) {
                db.ref(`products/${id}`).once('value', s => { 
                    const p = s.val(); 
                    document.getElementById('productName').value = p.name; 
                    document.getElementById('productPrice').value = p.price; 
                    document.getElementById('productStock').value = p.stock || 0;
                    document.getElementById('productLowStockAlert').value = p.lowStockAlert || 5;
                    document.getElementById('productImageUrl').value = p.imageUrl || ''; 
                    document.getElementById('productDescription').value = p.description || ''; 
                });
            } else {
                document.getElementById('productStock').value = 0;
                document.getElementById('productLowStockAlert').value = 5;
            }
            document.getElementById('productModal').style.display = 'flex';
        }
        
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const stock = parseInt(document.getElementById('productStock').value);
            const lowStockAlert = parseInt(document.getElementById('productLowStockAlert').value);
            
            const data = { 
                name: document.getElementById('productName').value, 
                price: parseFloat(document.getElementById('productPrice').value), 
                stock: stock,
                lowStockAlert: lowStockAlert,
                imageUrl: document.getElementById('productImageUrl').value, 
                description: document.getElementById('productDescription').value
            };
            
            // Automatically set status based on stock
            if (stock <= 0) {
                data.status = 'out_of_stock';
            } else if (stock <= lowStockAlert) {
                data.status = 'low_stock';
            } else {
                data.status = 'active';
            }
            
            const ref = id ? db.ref(`products/${id}`) : db.ref('products').push();
            ref.set(data).then(() => {
                document.getElementById('productModal').style.display = 'none';
                
                // Record stock history if this is a new product or stock changed
                if (!id || (id && productsData[id] && productsData[id].stock !== data.stock)) {
                    const stockHistory = {
                        productId: id || ref.key,
                        productName: data.name,
                        previousStock: id ? (productsData[id]?.stock || 0) : 0,
                        newStock: data.stock,
                        adjustment: id ? (data.stock - (productsData[id]?.stock || 0)) : data.stock,
                        reason: id ? 'product_edit' : 'new_product',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        updatedBy: auth.currentUser.email
                    };
                    db.ref('stockHistory').push(stockHistory);
                }
            });
        }
        
        window.editProduct = id => openProductModal(id);
        window.deleteProduct = id => { 
            if (confirm('Delete this product?')) db.ref(`products/${id}`).remove(); 
        }
        
        window.updateStockModal = id => {
            if (!productsData[id]) return;
            
            const product = productsData[id];
            document.getElementById('stockProductId').value = id;
            document.getElementById('stockProductName').value = product.name;
            document.getElementById('stockCurrent').value = product.stock || 0;
            document.getElementById('stockAdjustment').value = '';
            document.getElementById('stockReason').value = 'restock';
            document.getElementById('stockNotes').value = '';
            
            document.getElementById('stockModal').style.display = 'flex';
        };
        
        function updateStock(e) {
            e.preventDefault();
            const productId = document.getElementById('stockProductId').value;
            const adjustment = parseInt(document.getElementById('stockAdjustment').value);
            const reason = document.getElementById('stockReason').value;
            const notes = document.getElementById('stockNotes').value;
            
            if (!productId || isNaN(adjustment)) {
                alert('Please enter a valid adjustment value');
                return;
            }
            
            const currentStock = parseInt(document.getElementById('stockCurrent').value);
            const newStock = currentStock + adjustment;
            
            if (newStock < 0) {
                alert('Stock cannot be negative');
                return;
            }
            
            // Update product stock and status
            let status = 'active';
            const lowStockAlert = productsData[productId].lowStockAlert || 5;
            
            if (newStock <= 0) {
                status = 'out_of_stock';
            } else if (newStock <= lowStockAlert) {
                status = 'low_stock';
            }
            
            const updates = {
                stock: newStock,
                status: status
            };
            
            db.ref(`products/${productId}`).update(updates)
                .then(() => {
                    // Record stock history
                    const stockHistory = {
                        productId: productId,
                        productName: productsData[productId].name,
                        previousStock: currentStock,
                        newStock: newStock,
                        adjustment: adjustment,
                        reason: reason,
                        notes: notes,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        updatedBy: auth.currentUser.email
                    };
                    
                    return db.ref('stockHistory').push(stockHistory);
                })
                .then(() => {
                    document.getElementById('stockModal').style.display = 'none';
                })
                .catch(error => {
                    alert('Error updating stock: ' + error.message);
                });
        }
        
        window.viewStockHistory = productId => {
            if (!productId) return;
            
            // Create a modal to display stock history
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            
            let historyHtml = '<h3>Stock History for ' + (productsData[productId]?.name || 'Unknown Product') + '</h3>';
            historyHtml += '<table class="data-table"><thead><tr><th>Date</th><th>Previous</th><th>Adjustment</th><th>New Stock</th><th>Reason</th><th>Updated By</th></tr></thead><tbody>';
            
            // Filter and display stock history for this product
            if (stockHistoryData) {
                Object.keys(stockHistoryData)
                    .filter(key => stockHistoryData[key].productId === productId)
                    .sort((a, b) => new Date(stockHistoryData[b].timestamp) - new Date(stockHistoryData[a].timestamp))
                    .forEach(key => {
                        const record = stockHistoryData[key];
                        historyHtml += `
                            <tr>
                                <td>${new Date(record.timestamp).toLocaleString()}</td>
                                <td>${record.previousStock}</td>
                                <td>${record.adjustment > 0 ? '+' : ''}${record.adjustment}</td>
                                <td>${record.newStock}</td>
                                <td>${record.reason}</td>
                                <td>${record.updatedBy || 'System'}</td>
                            </tr>
                        `;
                    });
            }
            
            historyHtml += '</tbody></table>';
            historyHtml += '<button onclick="this.parentElement.style.display=\'none\'" class="btn btn-primary" style="margin-top:20px;">Close</button>';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
                    ${historyHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Export Functions for Messages
        function exportMessagesToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Eldavily - Customer Messages Report', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
            
            // Add messages table
            const tableColumn = ["Name", "Email", "Phone", "Message", "Date", "Status"];
            const tableRows = [];
            
            Object.keys(contactMessagesData).forEach(key => {
                const message = contactMessagesData[key];
                const status = message.read ? 'Read' : 'Unread';
                const messagePreview = message.message.length > 50 ? message.message.substring(0, 50) + '...' : message.message;
                
                const messageRow = [
                    message.name,
                    message.email,
                    message.phone || 'Not provided',
                    messagePreview,
                    new Date(message.sentAt).toLocaleDateString(),
                    status
                ];
                tableRows.push(messageRow);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [201, 169, 109] }
            });
            
            doc.save(`Eldavily_Messages_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        function exportMessagesToExcel() {
            const wb = XLSX.utils.book_new();
            wb.SheetNames.push("Messages");
            
            const data = [
                ["Name", "Email", "Phone", "Message", "Date", "Status"]
            ];
            
            Object.keys(contactMessagesData).forEach(key => {
                const message = contactMessagesData[key];
                const status = message.read ? 'Read' : 'Unread';
                
                data.push([
                    message.name,
                    message.email,
                    message.phone || 'Not provided',
                    message.message,
                    new Date(message.sentAt).toLocaleDateString(),
                    status
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            wb.Sheets["Messages"] = ws;
            
            XLSX.writeFile(wb, `Eldavily_Messages_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // Other export functions remain the same...
        
    </script>
</body>
</html>
