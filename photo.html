<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Management - Eldavily Admin</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    /* Inspired by the Eldavily Admin Panel style.
      This CSS provides a professional, light-themed design.
    */
    :root {
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #2b2b2b;
      --muted-text: #6c757d;
      --primary-color: #1a1a1a;
      --accent-color: #c9a96d; /* Golden accent */
      --accent-hover: #b89a5f;
      --border-color: #e0e0e0;
      --radius: 8px;
      --card-shadow: 0 5px 25px rgba(0, 0, 0, 0.07);
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --font-primary: 'Playfair Display', serif;
      --font-secondary: 'Montserrat', sans-serif;
    }
    
    html, body { 
      height: 100%; 
    }
    
    body {
      font-family: var(--font-secondary);
      background: var(--bg-color);
      color: var(--text-color);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
    }
    
    h1, h2, h3 { 
      font-family: var(--font-primary);
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .app { 
      max-width: 900px; 
      margin: 0 auto; 
      padding: 2rem 1rem;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border: none;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: var(--accent-color);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      background-color: var(--accent-hover);
    }
    .btn-secondary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-secondary:hover:not(:disabled) {
      background-color: #333;
    }
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    .btn-danger:hover:not(:disabled) {
      background-color: #c82333;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .form-input {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px 12px;
      color: var(--text-color);
      width: 100%;
      margin-bottom: 12px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(201, 169, 109, 0.2);
    }
    
    /* Toast (Notification) Styles */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      padding: 12px 16px;
      border-radius: var(--radius);
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInUp 0.3s ease;
    }

    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    
    @keyframes slideInUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Spinner Animation */
    .spinner {
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    .btn .spinner { border-top-color: white; }

    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Image Gallery Styles */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    
    .gallery-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .gallery-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: rgba(220, 53, 69, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s ease;
      z-index: 10;
    }
    .gallery-item:hover .delete-btn {
      opacity: 1;
      transform: scale(1);
    }
    .delete-btn:hover { background-color: var(--danger); }
    
    #video-preview { display: none; width: 100%; height: auto; border-radius: var(--radius); margin-top: 1rem; border: 1px solid var(--border-color); }
    #camera-controls { display: none; gap: 1rem; margin-top: 1rem; justify-content: center; }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(5px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.active { display: flex; opacity: 1; }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    .modal.active .modal-content { transform: scale(1); }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title { font-size: 1.5rem; margin: 0; }
    
    .close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted-text); line-height: 1; }
    
    .modal-body { padding: 20px; }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>

  <div id="toastContainer" class="toast-container"></div>
  
  <main class="app">
    <header class="flex items-center justify-between mb-8">
      <h1 class="text-3xl">Image Management</h1>
      <a href="index.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Admin
      </a>
    </header>

    <div class="card mb-8">
      <h2 class="text-2xl mb-2">Upload New Image</h2>
      <p class="text-[var(--muted-text)] mb-6">Select an image from your device or capture one. Images will be optimized for faster loading.</p>
      
      <div class="space-y-4">
        <label>
          <input type="file" id="image-upload" accept="image/*" class="form-input text-[var(--muted-text)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 transition-colors duration-200">
        </label>
        <div class="flex gap-4 flex-col sm:flex-row">
          <button id="camera-button" class="btn btn-secondary flex-1">
            <i class="fas fa-camera"></i> Capture Photo
          </button>
          <button id="upload-button" class="btn btn-primary flex-1">
            <i class="fas fa-cloud-upload-alt"></i> Upload Image
          </button>
        </div>
      </div>
      
      <video id="video-preview" autoplay playsinline></video>
      <div id="camera-controls">
        <button id="take-photo-button" class="btn flex-1 bg-[var(--success)] text-white hover:bg-green-600">Take Photo</button>
        <button id="cancel-camera-button" class="btn flex-1 btn-danger">Cancel</button>
      </div>
      <canvas id="photo-canvas" style="display:none;"></canvas>
    </div>

    <div class="card">
      <h2 class="text-2xl mb-4">Image Gallery</h2>
      <div id="gallery-container" class="image-gallery">
        </div>
    </div>
  </main>
  
  <div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="confirmModalTitle" class="modal-title">Confirm Deletion</h3>
            <button type="button" class="close-btn" data-modal-close="confirmModal">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure you want to delete this image? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-modal-close="confirmModal">Cancel</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</button>
        </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCyPOzsEzdrRd9o7iHASzFoLyJQhpTW83E",
            authDomain: "imandou-food.firebaseapp.com",
            databaseURL: "https://imandou-food-default-rtdb.firebaseio.com",
            projectId: "imandou-food",
            storageBucket: "imandou-food.appspot.com",
            messagingSenderId: "839302179988",
            appId: "1:839302179988:web:92636c32e1b00b587ad881",
        };
        const CLOUD_NAME = "dzc99hze9";
        const UPLOAD_PRESET = "testaben";
        
        // --- STATE VARIABLES ---
        let cameraStream = null;
        let deleteCallback = null;
        
        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(FIREBASE_CONFIG);
        const imagesRef = firebase.database().ref('images');
        
        // --- DOM ELEMENTS ---
        const elements = {
            toastContainer: document.getElementById('toastContainer'),
            fileInput: document.getElementById('image-upload'),
            uploadButton: document.getElementById('upload-button'),
            cameraButton: document.getElementById('camera-button'),
            takePhotoButton: document.getElementById('take-photo-button'),
            cancelButton: document.getElementById('cancel-camera-button'),
            videoPreview: document.getElementById('video-preview'),
            cameraControls: document.getElementById('camera-controls'),
            photoCanvas: document.getElementById('photo-canvas'),
            galleryContainer: document.getElementById('gallery-container'),
            confirmModal: document.getElementById('confirmModal'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
        };

        // ------------------------
        // HELPER FUNCTIONS
        // ------------------------
        
        function _toggleLoading(button, isLoading) {
            if (isLoading) {
                button.dataset.originalHtml = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div>';
                button.disabled = true;
            } else if (button.dataset.originalHtml) {
                button.innerHTML = button.dataset.originalHtml;
                button.disabled = false;
            }
        }
        
        function _showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        function _toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('active', show);
            }
        }

        function _showConfirmModal(callback) {
            deleteCallback = callback;
            _toggleModal('confirmModal', true);
        }

        function _confirmDelete() {
            if (typeof deleteCallback === 'function') {
                deleteCallback();
                _toggleModal('confirmModal', false);
                deleteCallback = null;
            }
        }
        
        function _firebaseObjectToArray(snapshot) {
            const data = snapshot.val();
            return data ? Object.keys(data).map(key => ({ key, ...data[key] })) : [];
        }

        // ---------------------------------
        // ✨ IMAGE OPTIMIZATION FUNCTION ✨
        // ---------------------------------
        /**
         * Resizes and compresses an image file before upload.
         * @param {File} file - The image file to process.
         * @param {number} maxSize - The maximum width or height of the image.
         * @param {number} quality - The JPEG quality (0 to 1).
         * @returns {Promise<Blob>} A promise that resolves with the compressed image blob.
         */
        function _resizeAndCompressImage(file, maxSize = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let { width, height } = img;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(blob => {
                        URL.revokeObjectURL(img.src); // Clean up memory
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.onerror = error => {
                    URL.revokeObjectURL(img.src);
                    reject(error);
                };
            });
        }

        // ---------------------------------
        // UPLOAD & CAMERA FUNCTIONS
        // ---------------------------------
        
        async function _uploadToCloudinary(file) {
            _toggleLoading(elements.uploadButton, true);
            
            try {
                // ✨ Compress the image first
                const compressedFileBlob = await _resizeAndCompressImage(file);
                
                const formData = new FormData();
                formData.append('file', compressedFileBlob, file.name); // Use original name
                formData.append('upload_preset', UPLOAD_PRESET);
                
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    _showToast('Image uploaded successfully!', 'success');
                    _saveImageUrlToDB(data.secure_url);
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                _showToast(`Upload failed: ${error.message}`, 'error');
                console.error('Upload Error:', error);
            } finally {
                _toggleLoading(elements.uploadButton, false);
                elements.fileInput.value = '';
            }
        }

        async function _startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                elements.videoPreview.srcObject = cameraStream;
                elements.videoPreview.style.display = 'block';
                elements.cameraControls.style.display = 'flex';
                elements.cameraButton.style.display = 'none';
            } catch (err) {
                _showToast('Could not access the camera.', 'error');
                console.error("Camera error:", err);
            }
        }

        function _stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            elements.videoPreview.style.display = 'none';
            elements.cameraControls.style.display = 'none';
            elements.cameraButton.style.display = 'block';
        }
        
        function _takePhoto() {
            return new Promise(resolve => {
                const canvas = elements.photoCanvas;
                const video = elements.videoPreview;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }
        
        // ---------------------------------
        // FIREBASE & GALLERY FUNCTIONS
        // ---------------------------------

        function _saveImageUrlToDB(url) {
            imagesRef.push({
                url: url,
                createdAt: new Date().toISOString()
            });
        }
        
        async function _deleteImageFromDB(key) {
            try {
                await imagesRef.child(key).remove();
                _showToast('Image deleted from gallery.', 'success');
            } catch (error) {
                _showToast(`Failed to delete: ${error.message}`, 'error');
            }
        }
        
        function _renderImageGallery(images) {
            const container = elements.galleryContainer;
            container.innerHTML = ''; // Clear previous content
            
            if (images.length === 0) {
                container.innerHTML = `<p class="text-[var(--muted-text)] col-span-full text-center">No images in the gallery yet. Upload one to get started.</p>`;
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.dataset.url = img.url;
                item.dataset.key = img.key;
                item.title = "Click to copy image URL";
                item.innerHTML = `
                    <button class="delete-btn" title="Delete Image"><i class="fas fa-trash"></i></button>
                    <img src="${img.url}" alt="Gallery Image" loading="lazy">
                `;
                container.appendChild(item);
            });
        }

        // ------------------------
        // EVENT LISTENERS SETUP
        // ------------------------
        
        function _setupEventListeners() {
            // Upload button for selected file
            elements.uploadButton.addEventListener('click', () => {
                const file = elements.fileInput.files[0];
                if (file) {
                    _uploadToCloudinary(file);
                } else {
                    _showToast('Please select a file first.', 'error');
                }
            });

            // Camera buttons
            elements.cameraButton.addEventListener('click', _startCamera);
            elements.cancelButton.addEventListener('click', _stopCamera);
            
            // Take Photo and Upload
            elements.takePhotoButton.addEventListener('click', async () => {
                _toggleLoading(elements.takePhotoButton, true);
                const photoBlob = await _takePhoto();
                _stopCamera();
                const photoFile = new File([photoBlob], "camera-photo.jpg", { type: "image/jpeg" });
                await _uploadToCloudinary(photoFile);
                _toggleLoading(elements.takePhotoButton, false);
            });
            
            // Gallery interactions (Copy URL & Delete)
            elements.galleryContainer.addEventListener('click', e => {
                const item = e.target.closest('.gallery-item');
                const deleteBtn = e.target.closest('.delete-btn');

                if (deleteBtn && item) {
                    e.stopPropagation();
                    const key = item.dataset.key;
                    _showConfirmModal(() => _deleteImageFromDB(key));
                } else if (item) {
                    const url = item.dataset.url;
                    navigator.clipboard.writeText(url)
                        .then(() => _showToast('Image URL copied!', 'success'))
                        .catch(err => _showToast('Failed to copy URL.', 'error'));
                }
            });

            // Modal deletion confirmation
            elements.confirmDeleteBtn.addEventListener('click', _confirmDelete);
            
            // Generic modal close handler
            document.addEventListener('click', e => { 
                if (e.target.dataset.modalClose) {
                    _toggleModal(e.target.dataset.modalClose, false);
                }
            });
        }

        // --- INITIALIZATION ---
        _setupEventListeners();

        // Listen for database changes and render the gallery
        imagesRef.on('value', snapshot => {
            const imagesData = _firebaseObjectToArray(snapshot);
            // Sort by newest first
            imagesData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            _renderImageGallery(imagesData);
        });

    });
  </script>
</body>
</html>

